from integralstor import command, config
import re
import os
import pprint


def rescan_drives():
    """Initiate a system rescan of all drives."""
    try:
        for dirname, dirs, files in os.walk('/sys/class/scsi_host/'):
            # print dirs
            for dir in dirs:
                # print '/sys/class/scsi_host/%s/scan'%dir
                with open('/sys/class/scsi_host/%s/scan' % dir, 'w') as f:
                    # print '/sys/class/scsi_host/%s/scan'%dir
                    f.write('- - -')
                    f.close()
    except Exception, e:
        return False, "Error rescanning drives : %s" % str(e)
    else:
        return True, None


def get_all_disks_by_name():
    """Get all disks by their sd* names

    Returns a list of all disks by name (sda/sbd, etc) in the sytem
    """
    dl = []
    try:
        cmd_dl = "/usr/sbin/smartctl --scan"
        (ret, rc), err = command.execute_with_rc(cmd_dl)
        if err:
            raise Exception(err)
        disk_list, err = command.get_output_list(ret)
        if err:
            raise Exception(err)

        if ret:
            # Regex to capture "/dev/sdX"
            reg_exp_dl = re.compile("(/dev/[a-z]+)")

            for line in disk_list:
                d = {}
                if reg_exp_dl.search(line):
                    result_dl = re.search(r'/dev/sd[a-z]+', line)
                    result_dl1 = re.search(r'/dev/(sd[a-z]+)', line)
                    if result_dl:
                        d["full_path"] = result_dl.group()
                        dname = result_dl1.groups()[0]
                        r = re.match('^sd[a-z]+', dname)
                        d["name"] = r.group()
                        dl.append(d)
        # print "disk list info: ", dl
    except Exception, e:
        return None, "Error retrieving disks by name : %s" % str(e)
    else:
        return dl, None


def get_all_disk_ids(disk_name):
    """Returns the /dev/disk/by-id entries corresponding to the name supplied"""
    ids = []
    try:
        supplied_path = '/dev/%s' % disk_name
        for (dirpath, dirnames, filenames) in os.walk('/dev/disk/by-id'):
            for file in filenames:
                real_path = os.path.realpath('%s/%s' % (dirpath, file))
                if real_path == supplied_path:
                    ids.append(file)
        # print 'name %s, ids '%disk_name, ids
    except Exception, e:
        return None, "Error retrieving all disk IDs : %s" % str(e)
    else:
        return ids, None


def get_disk_id(disk_name):
    """Returns the ID of the disk by examining the /dev/disk/by-id entries corresponding to the name supplied"""
    disk_id = None
    try:
        ids, err = get_all_disk_ids(disk_name)
        if err:
            raise Exception(err)
        if ids:
            for id in ids:
                if id.startswith('scsi'):
                    disk_id = id
                    break
        if not disk_id:
            for id in ids:
                if id.startswith('ata'):
                    disk_id = id
                    break
        if not disk_id:
            for id in ids:
                if id.startswith('wwn'):
                    disk_id = id
                    break
    except Exception, e:
        return None, "Error retrieving disk ID : %s" % str(e)
    else:
        return disk_id, None


def get_disk_scsi_info(disk_name):
    """Returns the /dev/disk/by-path entries corresponding to the name supplied."""
    scsi_info_list = []
    try:
        scsi_info = None
        supplied_path = '/dev/%s' % disk_name
        for (dirpath, dirnames, filenames) in os.walk('/sys/bus/scsi/drivers/sd'):
            for dir in dirnames:
                for (dpath, dnames, fnames) in os.walk('%s/%s/block' % (dirpath, dir)):
                    for d in dnames:
                        if d == disk_name:
                            scsi_info = dir
                            break
                    if scsi_info:
                        break
                if scsi_info:
                    break
            if scsi_info:
                break
        if scsi_info:
            l = scsi_info.split(':')
            if l:
                for comp in l:
                    scsi_info_list.append(int(comp))
    except Exception, e:
        return None, "Error retrieving disk SCSI info : %s" % str(e)
    else:
        return scsi_info_list, None


def get_disk_uuids(disk_name):
    """Returns the /dev/disk/by-uuid entries corresponding to the name supplied."""
    uuids = []
    try:
        supplied_path = '/dev/%s' % disk_name
        for (dirpath, dirnames, filenames) in os.walk('/dev/disk/by-uuid'):
            for file in filenames:
                real_path = os.path.realpath('%s/%s' % (dirpath, file))
                if real_path == supplied_path:
                    uuids.append(file)
    except Exception, e:
        return None, "Error retrieving disk UUID : %s" % str(e)
    else:
        return uuids, None


def is_rotational(disk_name):
    """Given a disk name like sda, returns true if its a rotational device"""
    rotational = True
    try:
        if not disk_name:
            raise Exception(
                "Disk name not specified. Could not determine rotational status")
        if os.path.isfile('/sys/block/%s/queue/rotational' % disk_name):
            with open('/sys/block/%s/queue/rotational' % disk_name) as f:
                str = f.read()
                if str.strip() == "1":
                    rotational = True
                else:
                    rotational = False
        else:
            raise Exception(
                "Configuration error. Rotational parameter not set for disk %s" % disk_name)
    except Exception, e:
        return None, "Error checking disk rotational status : %s" % str(e)
    else:
        return rotational, None


def get_capacity(name):
    """Given the name of a disk (like sda) OR a partition (like sda2), returns the capacity"""
    capacity = None
    try:
        # Get the storage capacity
        st1 = os.popen("/sbin/fdisk -l /dev/%s | grep Disk" % name)
        str2 = st1.read()
        disk_capacity = re.search(r'\s[0-9]+[\.0-9]*\s[a-zA-Z]+', str2)
        if disk_capacity:
            capacity = (disk_capacity.group()).strip()
        else:
            capacity = -1
    except Exception, e:
        return None, "Error getting disk capacity : %s" % str(e)
    else:
        return capacity, None


def get_all_partitions():
    """Get all partitions on all the disks"""
    partitions_list = []
    try:
        with open('/proc/partitions', 'r') as f:
            i = 0
            for line in f:
                if i == 0:
                    i += 1
                    continue
                if not line.strip():
                    continue
                comps = line.split()
                if len(comps) >= 4:
                    partitions_list.append(comps[3])
    except Exception, e:
        return None, "Error getting all partitions: %s" % str(e)
    else:
        return partitions_list, None


def get_partitions(disk_name):
    """Given a disk name like sda, returns all the partitions info like partition name, capacity, etc."""
    l = []
    try:
        if not disk_name:
            raise Exception(
                "No disk name specified so cannot retrieve partitions")
        supplied_path = '/dev/%s' % disk_name
        id_list = []
        for (dirpath, dirnames, filenames) in os.walk('/dev/disk/by-id'):
            id_list = filenames
            break
        for id1 in id_list:
            if (not id1.startswith('scsi')) and (not id1.startswith('ata')) and (not id1.startswith('wwn')):
                continue
            name = os.path.split(os.path.normpath(
                os.path.realpath('/dev/disk/by-id/%s' % id1)))[1]
            if 'part' not in id1:
                continue
            if re.findall(r'%s\d+' % disk_name, name):
                d = {}
                d['name'] = name
                capacity, err = get_capacity(name)
                if err:
                    raise Exception(err)
                if capacity:
                    d["capacity"] = capacity
                l.append(d)
    except Exception, e:
        return None, "Error retrieving partitions : %s" % str(e)
    else:
        return l, None


def get_os_partition_stats():
    ret_list = []
    try:
        lines, err = command.get_command_output(
            'df -HT --exclude-type=devtmpfs --exclude-type=tmpfs --exclude-type=zfs 2> /dev/null', check_rc=False, shell=True)
        if err:
            raise Exception(err)
        # print lines, err
        ret_list = []
        for line in lines[1:]:
            components = line.split()
            tmp_dict = {}
            # print components
            used_percentage_str = components[5]
            percentage_pos = used_percentage_str.find('%')
            used_percentage = int(used_percentage_str[:percentage_pos])
            free_percentage = 100 - used_percentage
            tmp_dict['percentage_free_str'] = '%d%%' % free_percentage
            tmp_dict['percentage_free'] = free_percentage
            tmp_dict['fs_name'] = components[6]
            tmp_dict['used'] = components[3]
            tmp_dict['capacity'] = components[2]
            tmp_dict['free'] = components[4]
            ret_list.append(tmp_dict)
    except Exception, e:
        return None, "Error retrieving OS partition statistics : %s" % str(e)
    else:
        return ret_list, None


def get_serial_number(disk_name):
    """Given a disk by name, get its serial number."""
    serial_number = None
    try:
        """
        ids, err = get_all_disk_ids(disk_name)
        if err:
          raise Exception(err)
        id1 = None
        id = None
        if ids:
          for id1 in ids:
            if (id1.startswith('scsi')) or (id1.startswith('ata')):
              id = id1
              break
        if id:
          parts = id.split('_')
          if len(parts) >= 3:
            serial_number = parts[2]
        """
        #cmd = 'udevadm info -q property -n %s | grep -ie ID_SERIAL_SHORT | cut -d "=" -f2' % disk_name
        cmd = 'udevadm info -q property -n %s | grep -ie ID_SCSI_SERIAL | cut -d "=" -f2' % disk_name
        ret, err = command.get_command_output(cmd, shell=True)
        if err:
            raise Exception(err)
        if ret:
            serial_number = ret[0]
        if not serial_number:
            # Cant get it this way for some SAS drives so try smartctl
            cmd_disk = "/usr/sbin/smartctl -H -i /dev/%s" % disk_name
            dl_output = os.popen(cmd_disk).read()
            lines = re.split("\r?\n", dl_output)

            for line in lines:
                # In case of a SAS drive, status comes with a different string
                # so ..
                res = re.match('Serial Number:[\s]*([\S]*)', line)
                if not res:
                    # For SAS drives, we get a lower case number, *&^@*&^
                    res = re.match('Serial number:[\s]*([\S]*)', line)
                if res:
                    tup = res.groups()
                    if tup:
                        serial_number = tup[0]
        if serial_number:
            serial_number = serial_number.upper()
    except Exception, e:
        return None, "Error retrieving serial number : %s" % str(e)
    else:
        return serial_number, None


def get_smart_status(disk_name):
    """Given a disk by name, get its S.M.A.R.T status."""
    status = None
    try:
        cmd_disk = "/usr/sbin/smartctl -H -i /dev/%s" % disk_name
        dl_output = os.popen(cmd_disk).read()
        lines = re.split("\r?\n", dl_output)
        reobj2 = re.compile(".*self-assessment.*")

        for line in lines:
            # In case of a SAS drive, status comes with a different string so
            # ..
            res = re.match('SMART Health Status: ([\w\W ]*)$', line)
            if res:
                tup = res.groups()
                if tup:
                    status = tup[0]
            if not status:
                if reobj2.search(line):
                    ent = re.search(r'\s[A-Z]+', line)
                    status = (ent.group()).strip()
    except Exception, e:
        return None, "Error getting disk S.M.A.R.T status : %s" % str(e)
    else:
        return status, None


def get_all_mounted_devices():
    """Get all mounted devices. """
    mounted_devices = []
    try:
        with open('/proc/mounts', 'r') as f:
            for line in f:
                if not line.strip():
                    continue
                comps = line.split()
                if len(comps) >= 1:
                    dev = comps[0]
                    if '/dev/' not in dev:
                        continue
                    device = dev[5:]
                    mounted_devices.append(device)
    except Exception, e:
        return None, "Error getting all mounted devices: %s" % str(e)
    else:
        return mounted_devices, None


def get_swap_devices():
    """Get the device being used for swap."""
    swap_devices = []
    try:
        with open('/proc/swaps', 'r') as f:
            i = 0
            for line in f:
                if i == 0:
                    i += 1
                    continue
                if not line.strip():
                    continue
                comps = line.split()
                if comps[1].strip().lower() == 'partition' and '/dev/' in comps[0]:
                    swap_devices.append(comps[0][5:])
    except Exception, e:
        return None, "Error getting swap devices: %s" % str(e)
    else:
        return swap_devices, None


def get_mdraid_info(device):
    """Get the devices that are part of the mdraids."""
    raid_list = []
    try:
        lines, err = command.get_command_output(
            'mdadm --detail /dev/%s' % device)
        if not err:
            for line in lines:
                # print line
                if line.startswith('/dev/%s' % device):
                    continue
                if not line.strip():
                    continue
                if not ':' in line:
                    # print line
                    comps = line.split()
                    if len(comps) > 5:
                        raid_list.append(comps[-1][5:])
    except Exception, e:
        return None, "Error getting mdraid information: %s" % str(e)
    else:
        return raid_list, None


def get_os_partitions():
    """Get all the devices that hold the OS and swap."""
    os_partitions = []
    try:
        check_devices = []
        pl, err = get_all_partitions()
        if err:
            raise Exception(err)
        md, err = get_all_mounted_devices()
        if err:
            raise Exception(err)
        for dev in md:
            if dev in pl:
                check_devices.append(dev)
        sd, err = get_swap_devices()
        if err:
            raise Exception(err)
        for dev in sd:
            if dev in pl and dev not in check_devices:
                check_devices.append(dev)
        for dev in check_devices:
            # If it is a mdraid device, get the underlying devices
            dl, err = get_mdraid_info(dev)
            if dl:
                os_partitions.extend(dl)
            else:
                os_partitions.append(dev)
    except Exception, e:
        return None, "Error getting OS partitions : %s" % str(e)
    else:
        return os_partitions, None


def get_disk_status(disk_name):
    """Get the smart status of dell hw raid status if applicable of a disk given its name """
    return_list = []
    try:
        hw_platform, err = config.get_hardware_platform()
        hw_raid = False
        disk_hw_info_all = {}
        if hw_platform and hw_platform == 'dell':
            from platforms import dell
            disk_hw_info_tmp, err = dell.get_all_disks(0)
            iter = 1
            while disk_hw_info_tmp:
                disk_hw_info_all.update(disk_hw_info_tmp)
                disk_hw_info_tmp, err = dell.get_all_disks(iter)
                iter += 1
            raid_to_unix_mapping, err = dell.get_hardware_raid_to_unix_mapping()
            if raid_to_unix_mapping and '/dev/%s' % disk_name in raid_to_unix_mapping.keys():
                # Its a hardware RAID so pull the underlying info
                hw_raid = True
                controller_id = raid_to_unix_mapping['/dev/%s' %
                                                     disk_name]['controller_number']
                device_id = raid_to_unix_mapping['/dev/%s' %
                                                 disk_name]['device_id']
                disk_list, err = dell.get_hardware_raid_hard_drives(
                    controller_id, device_id)
                if disk_list:
                    for disk in disk_list:
                        disk_dict = {}
                        disk_dict['serial_number'] = disk['serial_number']
                        disk_dict['hw_raid'] = True
                        disk_dict['status'] = disk['status']
                        return_list.append(disk_dict)
        if not hw_raid:
            disk_dict = {}
            serial_number, err = get_serial_number(disk_name)
            if err:
                raise Exception(err)
            disk_dict['serial_number'] = serial_number
            status, err = get_smart_status(disk_name)
            if err:
                raise Exception(err)
            disk_dict['status'] = status
            return_list.append(disk_dict)

        partitions, err = get_partitions(disk_name)
        if err:
            raise Exception(err)
        scsi_info, err = get_disk_scsi_info(disk_name)
        if err:
            raise Exception(err)
        for disk_dict in return_list:
            if partitions:
                disk_dict['partitions'] = partitions
            if scsi_info:
                disk_dict['scsi_info'] = scsi_info
            disk_dict['name'] = disk_name
            disk_dict['path'] = '/dev/%s' % disk_name
            if hw_platform and hw_platform == 'dell':
                if disk_hw_info_all:
                    for si_no in disk_hw_info_all.keys():
                        if si_no in disk_dict['serial_number'] or disk_dict['serial_number'] in si_no:
                            serial_number = si_no
                            disk_dict['target_id'] = disk_hw_info_all[serial_number]['target_id']
                            disk_dict['controller_number'] = disk_hw_info_all[serial_number]['controller_number']
                            disk_dict['enclosure_id'] = disk_hw_info_all[serial_number]['enclosure_id']
                            disk_dict['channel'] = disk_hw_info_all[serial_number]['channel']
    except Exception, e:
        return None, "Error getting disk status : %s" % str(e)
    else:
        return return_list, None


def get_disk_info(disk_name):
    """Get all details about a disk given its name """

    # Given a disk name like sda, get the disk info
    return_list = []
    try:
        disk_id, err = get_disk_id(disk_name)
        if err:
            raise Exception(err)

        capacity, err = get_capacity(disk_name)
        if err:
            raise Exception(err)

        rotational, err = is_rotational(disk_name)
        if err:
            raise Exception(err)

        os_partitions, err = get_os_partitions()
        if err:
            raise Exception(err)

        partitions, err = get_partitions(disk_name)
        if err:
            raise Exception(err)

        raid = False
        hw_platform, err = config.get_hardware_platform()
        if hw_platform and hw_platform == 'dell':
            from platforms import dell
            raid_to_unix_mapping, err = dell.get_hardware_raid_to_unix_mapping()
            if raid_to_unix_mapping and '/dev/%s' % disk_name in raid_to_unix_mapping.keys():
                # Its a hardware RAID so pull the underlying info
                raid = True
                controller_id = raid_to_unix_mapping['/dev/%s' %
                                                     disk_name]['controller_number']
                device_id = raid_to_unix_mapping['/dev/%s' %
                                                 disk_name]['device_id']
                disk_list, err = dell.get_hardware_raid_hard_drives(
                    controller_id, device_id)
                if disk_list:
                    for disk in disk_list:
                        disk_dict = {}
                        disk_dict['serial_number'] = disk['serial_number']
                        #disk_dict['name'] = disk_name
                        #disk_dict['path'] = '/dev/%s' % disk_name
                        disk_dict['id'] = disk_id
                        disk_dict['capacity'] = capacity
                        disk_dict['rotational'] = rotational
                        disk_dict['hw_raid'] = True
                        return_list.append(disk_dict)
        if not raid:
            disk_dict = {}
            disk_dict['hw_raid'] = False
            disk_dict['id'] = disk_id
            disk_dict['capacity'] = capacity
            serial_number, err = get_serial_number(disk_name)
            if err:
                raise Exception(err)
            disk_dict['serial_number'] = serial_number
            disk_dict['rotational'] = rotational
            return_list.append(disk_dict)

        for disk_dict in return_list:
            disk_dict['os_device'] = False
            if partitions:
                for partition in partitions:
                    if partition['name'] in os_partitions:
                        disk_dict['os_device'] = True

    except Exception, e:
        return None, "Error getting disk information : %s" % str(e)
    else:
        return return_list, None


def get_disk_info_status_all(rescan=False, type='info'):
    """Get all info or status about all disks depending on the type parameter

    Returns a structured dict for every disk that is alive
    """
    return_dict = {}
    try:
        if type not in ['info', 'status']:
            raise Exception('Invalid type passed')

        if rescan:
            out, err = rescan_drives()
            if err:
                raise Exception(err)

        all_disks, err = get_all_disks_by_name()
        if err:
            raise Exception(err)
        # print 'num all disks', len(all_disks)
        for disk_dict in all_disks:
            if type == 'info':
                disk_list, err = get_disk_info(disk_dict['name'])
            else:
                disk_list, err = get_disk_status(disk_dict['name'])
            if err:
                raise Exception(err)
            for disk_dict in disk_list:
                if disk_dict is not None and 'serial_number' in disk_dict:
                    return_dict[disk_dict['serial_number']] = disk_dict

    except Exception, e:
        return None, "Error getting complete disk information : %s" % str(e)
    else:
        return return_dict, None


def main():
    # pass
    pp = pprint.PrettyPrinter(indent=4)
    #d, err = get_all_disks_by_name()
    #d, err = get_all_disk_ids('sda')
    #d, err = get_disk_uuids('sde1')
    # print 'Disks by name : '
    # print get_disks_by_name()
    # print 'Disks by id : '
    # print  _get_disk_info_list()
    # print 'is rotational: '
    # print is_rotational('sde')
    # print get_capacity('sda')
    # print get_serial_number_and_status('sda')
    # print is_rotational('sdc')
    # print get_serial_number('sda')
    # print get_serial_number('sde')
    # print get_smart_status('sda')
    # print get_smart_status('sde')
    # print get_disk_scsi_info('sde')
    # print get_disk_scsi_info('sda')
    # print get_disk_scsi_info('sdb')

    # print 'Disk info: '
    #d, err = get_disk_info('sdd')
    # print err
    # pp.pprint(d)
    # print get_os_partition_stats()
    #d, err = get_disk_info_all()
    #d, err = get_all_partitions()
    #d, err = get_all_mounted_devices()
    #d, err = get_swap_devices()
    #d, err = get_mdraid_info('sda')
    #d, err = get_os_partitions()
    # print 'err is ', err
    d, err = get_disk_info('sdb')
    pp.pprint(d)
    d, err = get_disk_status('sdb')
    pp.pprint(d)
    # print 'Disk partitions: '
    # print get_partitions('sde')
    #r, err = _diskmap()
    # print r, err
    # print get_rootfs_device()
    # rescan_drives()
    # print get_disk_info('sdb')
    pass


if __name__ == '__main__':
    main()

# vim: tabstop=8 softtabstop=0 expandtab ai shiftwidth=4 smarttab
